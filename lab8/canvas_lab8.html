<!DOCTYPE html>
<html>
    
<head>
    <meta name = "viewport" content = "width=device-width">
</head>
<body>

<canvas id="myCanvas" width="800" height="600" style="border:1px solid #000000;">
Your browser does not support the HTML canvas tag.
</canvas>

<script>

    // SEBASTIAN PAWEÅOSZEK 215844

    let c = document.getElementById("myCanvas");
    let ctx = c.getContext("2d");
    let WIDTH = c.width
    let HEIGHT = c.height
    let UNITW = WIDTH/1000
    let UNITH = HEIGHT/1000

    let game = true

    window.addEventListener('resize', resizeCanvas, false);

    function resizeCanvas() {
            c.width = window.innerWidth - 3;
            c.height = window.innerHeight - 3;
            WIDTH = c.width
            HEIGHT = c.height
            UNITW = WIDTH/1000
            UNITH = HEIGHT/1000

            /**
             * Your drawings need to be inside this function otherwise they will be reset when 
             * you resize the browser window and the canvas goes will be cleared.
             */
            //drawStuff(); 
    }
    resizeCanvas();

    car = {
        x: WIDTH/3,
        y: HEIGHT - UNITH*330,
        width: UNITW*100,
        height: UNITH*100
    }

    keys = {
        up: false,
        down: false,
        left: false,
        down: false,
        space: false
    }

    mobile = {
        active: false,
        moveBy: 0.0
    }

    // preload images
    let images = ['car.png'];
    let loadedImages = {};
    let promiseArray = images.map(function(imgurl){
        let prom = new Promise(function(resolve,reject){
            let img = new Image();
            img.onload = function(){
                loadedImages[imgurl] = img;
                resolve();
            };
            img.src = imgurl;
        });
        return prom;
    });

    Promise.all(promiseArray).then(imagesLoaded);

    function imagesLoaded(){
        enableDeviceOrientation()

        setInterval(mainLoop, 20)
    }

    function enableDeviceOrientation() {
        if (typeof(DeviceOrientationEvent.requestPermission) === "function") {
            DeviceOrientationEvent.requestPermission()
            .then( permissionState => {
                if (permissionState === "granted") { 
                    window.ondevicemotion = function(event) {
                        
                        let x = event.accelerationIncludingGravity.x;
                        
                        if(x != null) {
                            mobile.active = true
                        }

                        if(x < 0) { // turn right
                            x = Math.abs(x)
                            keys.left = false
                            keys.right = true
                            if(x < -2.0) {
                                x = -2.0
                            }
                            mobile.moveBy = x/2.0
                        } else if (x > 0 ) { // turn left
                            keys.left = true
                            keys.right = false
                            if(x > 2.0) {
                                x = 2.0
                            }
                            mobile.moveBy = x/2.0
                        } else {
                            keys.left = false
                            keys.right = false
                        }
                    }
                }
            }).catch(console.error)
        } else {
            window.ondevicemotion = function(event) {
                let x = event.accelerationIncludingGravity.x;
                
                if(x != null) {
                    mobile.active = true
                }

                if(x < 0) { // turn right
                    x = Math.abs(x)
                    keys.left = false
                    keys.right = true
                    if(x < -2.0) {
                        x = -2.0
                    }
                    mobile.moveBy = x/2.0
                } else if (x > 0 ) { // turn left
                    keys.left = true
                    keys.right = false
                    if(x > 2.0) {
                        x = 2.0
                    }
                    mobile.moveBy = x/2.0
                } else {
                    keys.left = false
                    keys.right = false
                }
            }
        }
    }

    function mainLoop() {
        if(game) {
            drawBackground()
            //moveCar()
        } else {
            
        }
    }

    document.addEventListener('keydown', function(event) {
        let key = event.which
        if(key === 37) { // left arrow - move left
            keys.left = true
        } 
        if(key === 39) { // right arrow - move right
            keys.right = true
        } 
        if(key === 38) { // up arrow - move up
            keys.up = true
        }
        if(key === 40) { // down arrow - move down
            keys.down = true
        }
        if(key == 32) { // space - shot
            //shotMissile()
        }
    })

    document.addEventListener('keyup', function(event) {
        let key = event.which
        if(key === 37) { // left arrow - move left
            keys.left = false
        } 
        if(key === 39) { // right arrow - move right
            keys.right = false
        } 
        if(key === 38) { // up arrow - move up
            keys.up = false
        }
        if(key === 40) { // down arrow - move down
            keys.down = false
        }
    })

    function drawBackground() {
        ctx.fillStyle = "green";
        ctx.fillRect(0, 0, WIDTH, HEIGHT);
        ctx.fillStyle = "grey";
        //ctx.fillRect(WIDTH/4, -200, WIDTH/2, HEIGHT+400)
        //endRotateMode()
    }

    function drawCar() {
        drawImageRot("car.png", car.x, car.y, car.width, car.height, ROTATE)
    }

    function moveCar() {
        let moveCarBy = 15
        if(!mobile.active) {
            if(keys.left) { // left arrow - move left
                if(car.x - moveCarBy >= leftBorder) {
                    car.x = car.x - moveCarBy
                }
            } 
            if(keys.right) { // right arrow - move right
                if(car.x + car.width + moveCarBy <= rightBorder) {
                    car.x = car.x + moveCarBy
                }
            } 
        } else {
            if(keys.left) { // left arrow - move left
                if(car.x - (mobile.moveBy * moveCarBy) >= leftBorder) {
                    car.x = car.x - (mobile.moveBy * moveCarBy)

                }
            } 
            if(keys.right) { // right arrow - move right
                if(car.x + car.width + (mobile.moveBy * moveCarBy) <= rightBorder) {
                    car.x = car.x + (mobile.moveBy * moveCarBy)
                }
            } 
        }
        
        if(keys.up) { // up arrow - move up
            if(moveBy < 16) {
                moveBy += 1
            }
        }
        if(keys.down) { // down arrow - move down
            if(moveBy > 2) {
                moveBy -= 1
            }
        }
    }
    
    function randomInRange(minInclude, maxInculde) {
        let random = Math.random( );
        return random * (maxInculde - minInclude) + minInclude
    }

</script>

</body>
<style>
    * {
        touch-action: manipulation;
        margin:0; 
        padding:0;
    }
    canvas {
        display:block;
    }
    html, body { width:100%; height:100%; }
    </style>
</html>